<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>News Table</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 25px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 10px; border: 1px solid #ddd; vertical-align: top; }
    th { background: #f2f2f2; text-align: center; cursor: pointer; font-weight: bold; user-select: none; }
    tr:nth-child(even) { background: #fafafa; }
    #controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
    #controls input, #controls select, #controls button { padding: 6px 10px; font-size: 14px; height: auto; box-sizing: border-box; }
    .summary { display: none; margin-top: 5px; font-size: 14px; color: #333; }
    #newsTable th:nth-child(2), #newsTable td:nth-child(2) { width: 200px; max-width: 250px; }
    #newsTable th:nth-child(3), #newsTable td:nth-child(3) { width: 50px; max-width: 200px; white-space: nowrap; }
    #backToTopBtn { display: none; position: fixed; bottom: 20px; right: 20px; z-index: 99; padding: 12px 16px; font-size: 14px; background: #979797; color: white; border: none; border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
    @media screen and (max-width: 700px) {
      table, thead, tbody, th, td, tr { display: block; width: 100%; }
      th { display: none; }
      td:nth-child(2), td:nth-child(3) { display: none; }
      td a { font-weight: bold; font-size: 1.1rem; color: #555; display: block; margin-bottom: 5px; }
      td .mobile-meta { font-size: 1rem; color: #555; margin-bottom: 5px; }
      td .summary { font-size: 1rem; margin-top: 5px; display: none; }
    }
  </style>
</head>
<body>

<h2>News Feed 1.3</h2>

<div id="controls">

  <!-- Search Box -->
  <div class="control-group">
    <label for="searchBox">Search:</label>
    <input id="searchBox" type="text" placeholder="Search title, URL, or description..." />
  </div>

  <!-- Keyword exclusion -->
  <div class="control-group">
    <label for="keywordFilter">Exclude Keywords:</label>
    <input id="keywordFilter" type="text" placeholder="Comma-separated keywords..." />
  </div>

  <!-- Toggle summaries -->
  <div class="control-group">
    <button id="toggleAllBtn">Show Summaries</button>
  </div>

  <!-- Source filter -->
  <div class="control-group">
    <select id="sourceFilter">
      <option value="">All Sources</option>
    </select>
  </div>

  <!-- Time filter -->
  <div class="control-group">
    <select id="timeFilter">
      <option value="today">Today</option>
      <option value="last-week">Last Week</option>
      <option value="last-month">Last Month</option>
      <option value="last-year">Last Year</option>
      <option value="all-time">All Time</option>
    </select>
  </div>

</div>


<table id="newsTable"></table>

<button id="backToTopBtn" onclick="scrollToTop()">↑</button>

<script>
const DATA_URL = "https://umbrella-jam.github.io/regulator/data.json";
let jsonData = [];
let filteredData = [];
let sortState = {};
let searchTimeout;
let allVisible = false;

// Predefined excluded keywords (can be edited in the input)
const DEFAULT_EXCLUDED_KEYWORDS = [
  "gun","murder","drug","methamphetamine","cocaine","firearm",
  "narcotic","cyberstalk","sex","pornography","kidnapping","assault",
  "prostitut","fentanyl","shooting","robbery","homicide","office hours for librarians"
];

// Format dates
function prettyDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
}

// Populate Source Filter
function populateSourceFilter() {
  const select = document.getElementById("sourceFilter");
  const sources = [...new Set(jsonData.map(row => row.source))].sort();
  sources.forEach(src => {
    const opt = document.createElement("option");
    opt.value = src;
    opt.textContent = src;
    select.appendChild(opt);
  });
}

// Time filtering
function filterByTimeRange(data, timeRange) {
  const now = new Date();
  return data.filter(row => {
    const pubDate = new Date(row.pubDate);
    const diff = now - pubDate;
    switch(timeRange) {
      case "today": return diff < 24*60*60*1000;
      case "last-week": return diff < 7*24*60*60*1000;
      case "last-month":
        const lastMonth = new Date(); lastMonth.setMonth(lastMonth.getMonth()-1);
        return pubDate >= lastMonth;
      case "last-year":
        const lastYear = new Date(); lastYear.setFullYear(lastYear.getFullYear()-1);
        return pubDate >= lastYear;
      case "all-time": return true;
      default: return true;
    }
  });
}

// Build table
function buildTable() {
  const table = document.getElementById("newsTable");
  if(filteredData.length === 0){
    table.innerHTML = "<tr><td colspan='3'>No matching articles found.</td></tr>";
    return;
  }
  let html = `<thead>
    <tr>
      <th onclick="sortTable('title')">Title ${sortState.title ? (sortState.title==='asc'?'▲':'▼') : ''}</th>
      <th onclick="sortTable('pubDate')">Publication Date ${sortState.pubDate ? (sortState.pubDate==='asc'?'▲':'▼') : ''}</th>
      <th onclick="sortTable('source')">Source ${sortState.source ? (sortState.source==='asc'?'▲':'▼') : ''}</th>
    </tr>
  </thead><tbody>`;
  filteredData.forEach((row,index)=>{
    html += `<tr>
      <td>
        <a href="${row.link}" target="_blank">${row.title}</a>
        <div class="mobile-meta">${row.source} | ${prettyDate(row.pubDate)}</div>
        <div class="summary" id="summary-${index}" style="display:${allVisible?'block':'none'};">${row.summary}</div>
      </td>
      <td>${prettyDate(row.pubDate)}</td>
      <td>${row.source}</td>
    </tr>`;
  });
  html += "</tbody>";
  table.innerHTML = html;
}

// Filter by keywords
function filterByKeywords(data, keywords) {
  const lowerKeywords = keywords.map(k=>k.toLowerCase());
  return data.filter(row=>{
    const text = ((row.title||"")+" "+(row.summary||"")).toLowerCase();
    return !lowerKeywords.some(kw => text.includes(kw));
  });
}

// Apply filters
function applyFilters() {
  const text = document.getElementById("searchBox").value.toLowerCase();
  const source = document.getElementById("sourceFilter").value;
  const timeRange = document.getElementById("timeFilter").value;
  const keywordText = document.getElementById("keywordFilter").value.toLowerCase();
  const keywords = keywordText.split(",").map(k=>k.trim()).filter(k=>k);

  filteredData = jsonData.filter(row=>{
    // Search across title, summary, and link
    const combinedText = ((row.title||"") + " " + (row.summary||"") + " " + (row.link||"")).toLowerCase();
    const searchMatch = combinedText.includes(text);

    const sourceMatch = source === "" || row.source === source;
    return searchMatch && sourceMatch;
  });

  // Time filter
  filteredData = filterByTimeRange(filteredData, timeRange);

  // Keyword filter
  const activeKeywords = keywords.length > 0 ? keywords : DEFAULT_EXCLUDED_KEYWORDS;
  filteredData = filterByKeywords(filteredData, activeKeywords);

  if(sortState.activeColumn){
    sortTable(sortState.activeColumn,true);
  } else {
    buildTable();
  }
}


// Debounce search input
function debounceSearch(){
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(applyFilters, 300);
}

// Sort table
function sortTable(column, internal=false){
  if(!internal){
    sortState[column] = sortState[column]==="asc"?"desc":"asc";
    sortState.activeColumn = column;
  }
  const direction = sortState[column] || "asc";

  filteredData.sort((a,b)=>{
    let valA = a[column]; let valB = b[column];
    if(column==="pubDate"){ valA=new Date(valA); valB=new Date(valB); }
    if(column==="title"){ valA=valA.toLowerCase(); valB=valB.toLowerCase(); }
    return direction==="asc" ? (valA>valB?1:-1) : (valA<valB?1:-1);
  });

  buildTable();
}

// Toggle summaries
function toggleAllSummaries(){
  allVisible = !allVisible;
  document.getElementById("toggleAllBtn").textContent = allVisible ? "Hide Summaries" : "Show Summaries";
  filteredData.forEach((_,i)=>{
    const el = document.getElementById(`summary-${i}`);
    if(el) el.style.display = allVisible ? "block":"none";
  });
}

// Back to top
window.onscroll = function(){ toggleBackToTop(); };
function toggleBackToTop(){
  const btn=document.getElementById("backToTopBtn");
  btn.style.display=(document.body.scrollTop>200||document.documentElement.scrollTop>200)?"block":"none";
}
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

// Event listeners
document.getElementById("searchBox").addEventListener("input", debounceSearch);
document.getElementById("keywordFilter").addEventListener("input", debounceSearch);
document.getElementById("sourceFilter").addEventListener("change", applyFilters);
document.getElementById("timeFilter").addEventListener("change", applyFilters);
document.getElementById("toggleAllBtn").addEventListener("click", toggleAllSummaries);

// Load data
fetch(DATA_URL)
  .then(res=>res.json())
  .then(data=>{
    // Sort newest to oldest on load
    jsonData = data.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

    // Set default excluded keywords in input
    document.getElementById("keywordFilter").value = DEFAULT_EXCLUDED_KEYWORDS.join(",");

    applyFilters(); // Applies default filters immediately
    populateSourceFilter();
  })
  .catch(err=>{
    document.getElementById("newsTable").innerHTML="<tr><td>Error loading data</td></tr>";
    console.error(err);
  });
</script>

</body>
</html>
