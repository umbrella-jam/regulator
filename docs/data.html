<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>News Table</title>

<style>
  body { font-family: Arial, sans-serif; margin: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 10px; border: 1px solid #ddd; vertical-align: top; }
  th { 
    background: #f2f2f2; 
    text-align: center; 
    cursor: pointer; 
    font-weight: bold; 
    user-select: none;
  }
  tr:nth-child(even) { background: #fafafa; }
  #controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
  }
  #controls input, #controls select, #controls button {
    padding: 8px 12px;
    font-size: 14px;
    height: 36px;
  }
  .summary { display: none; margin-top: 5px; font-size: 14px; color: #333; }
  #newsTable th:nth-child(2), #newsTable td:nth-child(2) { width: 200px; max-width: 250px; }
  #newsTable th:nth-child(3), #newsTable td:nth-child(3) { width: 50px; max-width: 200px; white-space: nowrap; }
</style>
</head>
<body>

<h2>News Feed</h2>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search by title..." />
  <button id="toggleAllBtn">Show All Summaries</button>
  <select id="sourceFilter">
    <option value="">All Sources</option>
  </select>
</div>

<table id="newsTable"></table>

<script>
const DATA_URL = "https://umbrella-jam.github.io/regulator/data.json";

let jsonData = [];
let filteredData = [];
let sortState = {};
let searchTimeout;
let allVisible = false;

function prettyDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
}

function populateSourceFilter() {
  const select = document.getElementById("sourceFilter");
  const sources = [...new Set(jsonData.map(row => row.source))];
  sources.forEach(src => {
    const opt = document.createElement("option");
    opt.value = src;
    opt.textContent = src;
    select.appendChild(opt);
  });
}

function toggleAllSummaries() {
  allVisible = !allVisible;
  document.getElementById("toggleAllBtn").textContent = allVisible ? "Hide All Summaries" : "Show All Summaries";
  filteredData.forEach((_, index) => {
    const summaryEl = document.getElementById(`summary-${index}`);
    if (summaryEl) summaryEl.style.display = allVisible ? "block" : "none";
  });
}

function buildTable() {
  const table = document.getElementById("newsTable");
  let html = `
    <thead>
      <tr>
        <th onclick="sortTable('title')">
          Title ${sortState.title ? (sortState.title === 'asc' ? '▲' : '▼') : ''}
        </th>
        <th onclick="sortTable('pubDate')">
          Publication Date ${sortState.pubDate ? (sortState.pubDate === 'asc' ? '▲' : '▼') : ''}
        </th>
        <th onclick="sortTable('source')">
          Source ${sortState.source ? (sortState.source === 'asc' ? '▲' : '▼') : ''}
        </th>
      </tr>
    </thead>
    <tbody>
  `;
  filteredData.forEach((row, index) => {
    html += `
      <tr>
        <td>
          <a href="${row.link}" target="_blank">${row.title}</a><br>
          <div class="summary" id="summary-${index}" style="display:${allVisible ? 'block' : 'none'};">${row.summary}</div>
        </td>
        <td>${prettyDate(row.pubDate)}</td>
        <td>${row.source}</td>
      </tr>`;
  });
  html += "</tbody>";
  table.innerHTML = html;
}

function applyFilters() {
  const text = document.getElementById("searchBox").value.toLowerCase();
  const source = document.getElementById("sourceFilter").value;

  filteredData = jsonData.filter(row => 
    row.title.toLowerCase().includes(text) &&
    (source === "" || row.source === source)
  );

  if (sortState.activeColumn) {
    sortTable(sortState.activeColumn, true);
  } else {
    buildTable();
  }
}

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(applyFilters, 300);
}

function sortTable(column, internal = false) {
  if (!internal) {
    sortState[column] = sortState[column] === "asc" ? "desc" : "asc";
    sortState.activeColumn = column;
  }
  const direction = sortState[column] || "asc";

  filteredData.sort((a, b) => {
    let valA = a[column];
    let valB = b[column];
    if (column === "pubDate") { valA = new Date(valA); valB = new Date(valB); }
    return direction === "asc" ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });

  buildTable();
}

// Event listeners
document.getElementById("searchBox").addEventListener("input", debounceSearch);
document.getElementById("sourceFilter").addEventListener("change", applyFilters);
document.getElementById("toggleAllBtn").addEventListener("click", toggleAllSummaries);

// Fetch JSON
fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    jsonData = data;
    filteredData = [...data];
    populateSourceFilter();
    buildTable();
  })
  .catch(err => {
    document.getElementById("newsTable").innerHTML = "<tr><td>Error loading data</td></tr>";
    console.error(err);
  });
</script>

</body>
</html>
