<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>News Table</title>

<style>
  body { font-family: Arial, sans-serif; margin: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 10px; border: 1px solid #ddd; vertical-align: top; }
  th { 
    background: #f2f2f2; 
    text-align: center; 
    cursor: pointer; 
    font-weight: bold; 
    user-select: none;
  }
  tr:nth-child(even) { background: #fafafa; }
  #searchBox, #sourceFilter { width: 200px; padding: 8px; font-size: 14px; margin-right: 10px; }
  .sort-indicator { margin-left: 6px; font-size: 12px; opacity: 0.6; }
  /* Make Publication Date column wider */
  #newsTable th:nth-child(2),
  #newsTable td:nth-child(2) {
    width: 200px; /* adjust as needed */
    max-width: 250px; /* optional */
  }
  /* Make Source column wider */
  #newsTable th:nth-child(3),
  #newsTable td:nth-child(3) {
    width: 50px; /* adjust as needed */
    max-width: 200px; /* optional to prevent overflow */
    white-space: nowrap; /* keep content on one line */
}
</style>
</head>
<body>

<h2>News Feed</h2>

<input id="searchBox" type="text" placeholder="Search by title..." onkeyup="applyFilters()" />
<select id="sourceFilter" onchange="applyFilters()">
  <option value="">All Sources</option>
</select>

<table id="newsTable"></table>

<script>
const DATA_URL = "https://raw.githubusercontent.com/umbrella-jam/regulator/refs/heads/main/docs/data.json";

let jsonData = [];
let filteredData = [];
let sortState = {}; // ascending/descending tracking

// Convert timestamp → readable date (date only)
function prettyDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
}



// Populate source dropdown dynamically
function populateSourceFilter() {
  const select = document.getElementById("sourceFilter");
  const sources = [...new Set(jsonData.map(row => row.source))];
  sources.forEach(src => {
    const opt = document.createElement("option");
    opt.value = src;
    opt.textContent = src;
    select.appendChild(opt);
  });
}

// Render table using *filteredData*
function buildTable() {
  const table = document.getElementById("newsTable");

  let html = `
    <thead>
      <tr>
        <th onclick="sortTable('title')">
          Title ${sortState.title ? (sortState.title === 'asc' ? '▲' : '▼') : ''}
        </th>
        <th onclick="sortTable('pubDate')">
          Publication Date ${sortState.pubDate ? (sortState.pubDate === 'asc' ? '▲' : '▼') : ''}
        </th>
        <th onclick="sortTable('source')">
          Source ${sortState.source ? (sortState.source === 'asc' ? '▲' : '▼') : ''}
        </th>
      </tr>
    </thead>
    <tbody>
  `;

  filteredData.forEach(row => {
    html += `
      <tr>
        <td><a href="${row.link}" target="_blank">${row.title}</a></td>
        <td>${prettyDate(row.pubDate)}</td>
        <td>${row.source}</td>
      </tr>`;
  });

  html += "</tbody>";
  table.innerHTML = html;
}

// Apply search + source filter + sorting
function applyFilters() {
  const text = document.getElementById("searchBox").value.toLowerCase();
  const source = document.getElementById("sourceFilter").value;

  filteredData = jsonData.filter(row => 
    row.title.toLowerCase().includes(text) &&
    (source === "" || row.source === source)
  );

  // Reapply sort to maintain persistence
  if (sortState.activeColumn) {
    sortTable(sortState.activeColumn, true); // internal sort
  } else {
    buildTable();
  }
}

// Sort (with support for internal re-sorting)
function sortTable(column, internal = false) {
  if (!internal) {
    sortState[column] = sortState[column] === "asc" ? "desc" : "asc";
    sortState.activeColumn = column;
  }

  const direction = sortState[column] || "asc";

  filteredData.sort((a, b) => {
    let valA = a[column];
    let valB = b[column];

    if (column === "pubDate") {
      valA = new Date(valA);
      valB = new Date(valB);
    }

    return direction === "asc"
      ? (valA > valB ? 1 : -1)
      : (valA < valB ? 1 : -1);
  });

  buildTable();
}

// Fetch JSON
fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    jsonData = data;
    filteredData = [...data];
    populateSourceFilter();
    buildTable();
  })
  .catch(err => {
    document.getElementById("newsTable").innerHTML = "<tr><td>Error loading data</td></tr>";
    console.error(err);
  });
</script>

</body>
</html>
