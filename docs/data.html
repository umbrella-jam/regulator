<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>News Table</title>
<style>
  body { font-family: Arial, sans-serif; margin: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 10px; border: 1px solid #ddd; vertical-align: top; }
  th { background: #f2f2f2; text-align: center; cursor: pointer; font-weight: bold; user-select: none; }
  tr:nth-child(even) { background: #fafafa; }

  #controls {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }
  #controls input, #controls select, #controls button {
    padding: 8px 12px;
    font-size: 14px;
    height: 36px;
  }

  .summary { display: none; margin-top: 5px; font-size: 14px; color: #333; }

  #newsTable th:nth-child(2), #newsTable td:nth-child(2) { width: 200px; max-width: 250px; }
  #newsTable th:nth-child(3), #newsTable td:nth-child(3) { width: 50px; max-width: 200px; white-space: nowrap; }

  #backToTopBtn {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 99;
    padding: 12px 16px;
    font-size: 14px;
    background: #979797;
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  /* Mobile styles */
  @media screen and (max-width: 700px) {
      table, thead, tbody, th, td, tr { display: block; width: 100%; }
      th { display: none; }

      /* Hide the separate source/date columns in mobile */
      td:nth-child(2), td:nth-child(3) { display: none; }

      td a { font-weight: bold; font-size: 34px; color: #555; display: block; margin-bottom: 5px; }
      td .mobile-meta { font-size: 30px; color: #555; margin-bottom: 5px; }
      td .summary { font-size: 30px; margin-top: 5px; display: none; }
  }

</style>
</head>
<body>

<h2>News Feed 1.1</h2>

<div id="controls">
  <input id="searchBox" type="text" placeholder="Search by title..." />
  <button id="toggleAllBtn">Show Summaries</button>
  <select id="sourceFilter">
    <option value="">All Sources</option>
  </select>
</div>

<table id="newsTable"></table>

<button id="backToTopBtn" onclick="scrollToTop()">↑</button>

<script>
const DATA_URL = "https://umbrella-jam.github.io/regulator/data.json";

let jsonData = [];
let filteredData = [];
let sortState = {};
let searchTimeout;
let allVisible = false;

function prettyDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString(undefined, { year: "numeric", month: "long", day: "numeric" });
}

function populateSourceFilter() {
  const select = document.getElementById("sourceFilter");
  const sources = [...new Set(jsonData.map(row => row.source))];
  sources.forEach(src => {
    const opt = document.createElement("option");
    opt.value = src;
    opt.textContent = src;
    select.appendChild(opt);
  });
}

function toggleAllSummaries() {
  allVisible = !allVisible;
  document.getElementById("toggleAllBtn").textContent = allVisible ? "Hide Summaries" : "Show Summaries";
  filteredData.forEach((_, index) => {
    const summaryEl = document.getElementById(`summary-${index}`);
    if (summaryEl) summaryEl.style.display = allVisible ? "block" : "none";
  });
}

function buildTable() {
  const table = document.getElementById("newsTable");
  let html = `
    <thead>
      <tr>
        <th onclick="sortTable('title')">
          Title ${sortState.title ? (sortState.title === 'asc' ? '▲' : '▼') : ''}
        </th>
        <th onclick="sortTable('pubDate')">
          Publication Date ${sortState.pubDate ? (sortState.pubDate === 'asc' ? '▲' : '▼') : ''}
        </th>
        <th onclick="sortTable('source')">
          Source ${sortState.source ? (sortState.source === 'asc' ? '▲' : '▼') : ''}
        </th>
      </tr>
    </thead>
    <tbody>
  `;
  filteredData.forEach((row, index) => {
    html += `
      <tr>
        <td>
            <a href="${row.link}" target="_blank">${row.title}</a>
            <div class="mobile-meta">${row.source} | ${prettyDate(row.pubDate)}</div>
            <div class="summary" id="summary-${index}" style="display:${allVisible ? 'block' : 'none'};">
                ${row.summary}
            </div>
        </td>
        <td>${prettyDate(row.pubDate)}</td>
        <td>${row.source}</td>
    </tr>`;
  });
  html += "</tbody>";
  table.innerHTML = html;
}

function applyFilters() {
  const text = document.getElementById("searchBox").value.toLowerCase();
  const source = document.getElementById("sourceFilter").value;

  filteredData = jsonData.filter(row => 
    row.title.toLowerCase().includes(text) &&
    (source === "" || row.source === source)
  );

  if (sortState.activeColumn) {
    sortTable(sortState.activeColumn, true);
  } else {
    buildTable();
  }
}

function debounceSearch() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(applyFilters, 300);
}

function sortTable(column, internal = false) {
  if (!internal) {
    sortState[column] = sortState[column] === "asc" ? "desc" : "asc";
    sortState.activeColumn = column;
  }
  const direction = sortState[column] || "asc";

  filteredData.sort((a, b) => {
    let valA = a[column];
    let valB = b[column];
    if (column === "pubDate") { valA = new Date(valA); valB = new Date(valB); }
    return direction === "asc" ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });

  buildTable();
}

// Back to top button
window.onscroll = function() { toggleBackToTop() };
function toggleBackToTop() {
  const btn = document.getElementById("backToTopBtn");
  btn.style.display = (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) ? "block" : "none";
}
function scrollToTop() { window.scrollTo({top:0, behavior:'smooth'}); }

document.getElementById("searchBox").addEventListener("input", debounceSearch);
document.getElementById("sourceFilter").addEventListener("change", applyFilters);
document.getElementById("toggleAllBtn").addEventListener("click", toggleAllSummaries);

fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    jsonData = data;
    filteredData = [...data];
    populateSourceFilter();
    buildTable();
  })
  .catch(err => {
    document.getElementById("newsTable").innerHTML = "<tr><td>Error loading data</td></tr>";
    console.error(err);
  });
</script>

</body>
</html>
