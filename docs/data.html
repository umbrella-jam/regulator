<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>News Table</title>

<style>
  body { font-family: Arial, sans-serif; margin: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 10px; border: 1px solid #ddd; vertical-align: top; }
  th { 
    background: #f2f2f2; 
    text-align: center; 
    cursor: pointer; 
    font-weight: bold; 
    user-select: none;
  }
  tr:nth-child(even) { background: #fafafa; }
  #searchBox { width: 300px; padding: 8px; font-size: 14px; }
  .sort-indicator { margin-left: 6px; font-size: 12px; opacity: 0.6; }
</style>
</head>
<body>

<h2>News Feed</h2>

<input id="searchBox" type="text" placeholder="Search..." onkeyup="applyFilters()" />

<table id="newsTable"></table>

<script>
const DATA_URL = "https://raw.githubusercontent.com/umbrella-jam/regulator/refs/heads/main/docs/data.json";

let jsonData = [];
let filteredData = [];
let sortState = {}; // ascending/descending tracking

// Convert timestamp → readable date
function prettyDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleString(undefined, {
    year: "numeric",
    month: "long",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });
}

// Render table using *filteredData*
function buildTable() {
  const table = document.getElementById("newsTable");

  let html = `
    <thead>
      <tr>
        <th onclick="sortTable('title')">
          Title ${sortState.title ? (sortState.title === 'asc' ? '▲' : '▼') : ''}
        </th>
        <th onclick="sortTable('pubDate')">
          Publication Date ${sortState.pubDate ? (sortState.pubDate === 'asc' ? '▲' : '▼') : ''}
        </th>
      </tr>
    </thead>
    <tbody>
  `;

  filteredData.forEach(row => {
    html += `
      <tr>
        <td><a href="${row.link}" target="_blank">${row.title}</a></td>
        <td>${prettyDate(row.pubDate)}</td>
      </tr>`;
  });

  html += "</tbody>";
  table.innerHTML = html;
}

// Apply search + sorting
function applyFilters() {
  const text = document.getElementById("searchBox").value.toLowerCase();

  // Filter first
  filteredData = jsonData.filter(row =>
    row.title.toLowerCase().includes(text)
  );

  // Then reapply sort to maintain persistence
  if (sortState.activeColumn) {
    sortTable(sortState.activeColumn, true); // internal sort
  } else {
    buildTable();
  }
}

// Sort (with support for internal re-sorting)
function sortTable(column, internal = false) {
  // Toggle direction only if the user clicked
  if (!internal) {
    sortState[column] = sortState[column] === "asc" ? "desc" : "asc";
    sortState.activeColumn = column;
  }

  const direction = sortState[column] || "asc";

  filteredData.sort((a, b) => {
    let valA = a[column];
    let valB = b[column];

    if (column === "pubDate") {
      valA = new Date(valA);
      valB = new Date(valB);
    }

    return direction === "asc"
      ? (valA > valB ? 1 : -1)
      : (valA < valB ? 1 : -1);
  });

  buildTable();
}

// Fetch JSON
fetch(DATA_URL)
  .then(res => res.json())
  .then(data => {
    jsonData = data;
    filteredData = [...data]; // initial
    buildTable();
  })
  .catch(err => {
    document.getElementById("newsTable").innerHTML = "<tr><td>Error loading data</td></tr>";
    console.error(err);
  });
</script>

</body>
</html>
